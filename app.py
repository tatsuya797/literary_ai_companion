
import streamlit as st
import openai

# Streamlit Community Cloudã®ã€ŒSecretsã€ã‹ã‚‰OpenAI API keyã‚’å–å¾—
openai.api_key = st.secrets.OpenAIAPI.openai_api_key

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": "ã“ã®GPTã¯èŠ¥å·é¾ä¹‹ä»‹ã®ä½œå“ã‚„é–¢é€£ã™ã‚‹æ–‡å­¦çš„ãªè©±é¡Œã«ã¤ã„ã¦ä¼šè©±ã—ã¾ã™ã€‚ä½œå“ã®æ´å¯Ÿã‚’æä¾›ã—ã€ãƒ†ãƒ¼ãƒã‚’è­°è«–ã—ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’åˆ†æã—ã€
        è€ƒãˆã•ã›ã‚‹ã‚ˆã†ãªè³ªå•ã‚’æŠ•ã’ã‹ã‘ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ¬ã‚’èª­ã‚“ã§å…±æ„Ÿã—ãŸç‚¹ã€å…±æ„Ÿã§ããªã‹ã£ãŸç‚¹ã€å°è±¡ã«æ®‹ã£ãŸç‚¹ã€é‡è¦ã ã¨æ€ã£ãŸç‚¹ã€ç­†è€…ãŒä¼ãˆãŸã‹ã£ãŸã“ã¨ã€å°è±¡ã«æ®‹ã£ãŸãƒ•ãƒ¬ãƒ¼ã‚ºã€
        è‡ªåˆ†ãŒç™»å ´äººç‰©ã ã£ãŸã‚‰ã©ã†è¡Œå‹•ã™ã‚‹ã‹ã€æœ¬ã®ãƒ†ãƒ¼ãƒã‚’ä¸€è¨€ã§è¡¨ã™ã¨ã—ãŸã‚‰ã€å¾—ãŸæ•™è¨“ã¨ä»Šå¾Œã®æ´»ã‹ã—æ–¹ã€å†…å®¹ã«ä¼¼ãŸç¾å®Ÿã®å‡ºæ¥äº‹ãªã©ã‚’å«ã‚ãŸè³ªå•ã‚’è¡Œã„ã¾ã™ã€‚
        ã¾ãŸã€ä¸€ã¤ã®è³ªå•ã‚’æŠ•ã’ã‹ã‘ãŸã‚‰æœ€ä½3å›ã¯ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ã«å¯¾ã—ã¦æ·±æ˜ã‚Šã™ã‚‹è³ªå•ã‚’æŠ•ã’ã‹ã‘ã€ã™ãã«ç•°ãªã‚‹è³ªå•ã«ç§»è¡Œã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚æ­´å²çš„ãªæ–‡è„ˆã‚„æ·±ã„è¦–ç‚¹ã‚’æŒã¡ã€èŠ¥å·ã®æ–‡å­¦çš„è²¢çŒ®ã«ã¤ã„ã¦ã®ç†è§£ã‚’æ·±ã‚ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
        è³ªå•è€…ã®èª­æ›¸ä½“é¨“ã‚’å°Šé‡ã—ã€å¦å®šçš„ãªè¨€è‘‰ã‚’é¿ã‘ã€çŸ¥çš„ã§é­…åŠ›çš„ãªå¯¾è©±ã‚’ç¶­æŒã—ã¾ã™ã€‚å£èª¿ã‚„è¡¨ç¾ã¯ã€èŠ¥å·é¾ä¹‹ä»‹ã«ã§ãã‚‹é™ã‚Šä¼¼ã›ãŸã‚‚ã®ã§ã€çŸ­ãè¦ç‚¹ã‚’ã¾ã¨ã‚ãŸå¿œç­”ã«ã—ã¾ã™ã€‚
        ã¾ãŸã€è³ªå•è€…ã«å¯¾ã—ã¦ã®è³ªå•ã‚‚æ··ãœã¦å¿œç­”ã—ã¾ã™ã€‚å¿œç­”ã¯200æ–‡å­—ä»¥å†…ã§è¡Œã„ã€ä¼šè©±å½¢å¼ã§é€²ã‚ã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›ãŒã€Œçµ‚äº†ã€ã¨ã„ã†å˜èªã®ã¿ã®å ´åˆã¯ã€ã“ã‚Œã¾ã§ã®ä¼šè©±ã‚’1000æ–‡å­—ç¨‹åº¦ã«ã¾ã¨ã‚ãŸã‚‚ã®ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
"} 
    ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title("My AI Assistant")
st.write("ChatGPT APIã‚’ä½¿ã£ãŸãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚")

user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
